 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Master Scheduler (Academic + Duty)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #2c3e50; --bg: #f8fafc; --border: #cbd5e0; --accent: #3b82f6; --highlight: #f39c12; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { background: white; padding: 0 20px; height: 60px; border-bottom: 1px solid #cbd5e0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; z-index: 100; }
        h2 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; flex-direction: column; line-height: 1.1; }
        
        .tabs { display: flex; background: #e2e8f0; padding: 3px; border-radius: 6px; gap: 2px; }
        .tab { border: none; background: none; padding: 5px 12px; font-weight: 700; color: #64748b; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .tab:hover { background: rgba(255,255,255,0.6); }
        .tab.active { background: white; color: var(--accent); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* Separator line in tabs */
        .tab-sep { width: 1px; background: #cbd5e0; margin: 0 4px; }

        .controls { display: flex; gap: 8px; }
        button { height: 30px; padding: 0 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; color: white; background: var(--accent); }
        button:hover { opacity: 0.9; }
        .btn-sec { background: #64748b; }
        .btn-imp { background: #8b5cf6; }
        .btn-csv { background: #10b981; }
        .btn-doc { background: #f97316; }
        .btn-share { background: #f59e0b; }

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background: white; border-right: 1px solid #cbd5e0; display: flex; flex-direction: column; z-index: 50; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        .group-header { 
            font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 800; 
            margin: 25px 0 8px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 4px;
        }
        .del-group-btn { cursor: pointer; color: #ef4444; font-size: 0.7rem; opacity: 0.6; transition: opacity 0.2s; }
        .del-group-btn:hover { opacity: 1; text-decoration: underline; }

        .chip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

        /* CHIPS */
        .chip { 
            padding: 8px 6px; font-size: 0.8rem; text-align: center; border-radius: 4px; 
            background: white; border: 1px solid #cbd5e0; font-weight: 600; 
            cursor: grab; user-select: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .chip:active { cursor: grabbing; }
        .chip.selected { background: #fff7ed; border: 2px solid var(--highlight); transform: scale(1.05); z-index: 10; }

        /* SYS BLOCKS */
        .sys { font-weight: 800; border: 1px solid #94a3b8; }
        .sys-lunch { background: #334155; color: white; }
        .sys-prep { background: repeating-linear-gradient(45deg, #e2e8f0, #e2e8f0 10px, #f1f5f9 10px, #f1f5f9 20px); color: #475569; }
        .sys-meet { background: #7c3aed; color: white; }
        /* NEW DUTY COLORS */
        .sys-duty { background: #059669; color: white; border-color: #047857; }

        /* GRID */
        .grid-area { flex: 1; overflow: auto; padding: 20px; }
        table { border-collapse: separate; border-spacing: 0; background: white; border: 1px solid #cbd5e0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        th { 
            background: var(--primary); color: white; padding: 12px; min-width: 130px;
            position: sticky; top: 0; z-index: 20; cursor: grab; border-right: 1px solid #ffffff30;
        }
        th.drag-over { background: var(--highlight) !important; }
        
        .time-head { 
            background: #f1f5f9; color: #334155; width: 110px; min-width: 110px; 
            position: sticky; left: 0; z-index: 30; cursor: default; border-right: 2px solid #cbd5e0;
            border-bottom: 1px solid #cbd5e0;
        }
        .corner { z-index: 40; background: #1e293b; color: white; border-right: 2px solid #0f172a; }

        td { border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; height: 80px; vertical-align: top; padding: 0; }
        
        .slot { 
            height: 100%; width: 100%; padding: 4px; 
            display: flex; flex-direction: column; gap: 4px; box-sizing: border-box; 
            cursor: pointer; 
        }
        .slot.drag-over { background-color: #dbeafe !important; outline: 2px dashed var(--accent); }
        .slot.target-active { background-color: #ecfdf5; outline: 2px dashed #10b981; }

        /* COLORS */
        .g-K { border-left: 4px solid #ef5350; } .g-1 { border-left: 4px solid #3b82f6; } 
        .g-2 { border-left: 4px solid #22c55e; } .g-3 { border-left: 4px solid #f59e0b; } 
        .g-4 { border-left: 4px solid #a855f7; } .g-5 { border-left: 4px solid #64748b; }
        .g-6 { border-left: 4px solid #06b6d4; } .g-7 { border-left: 4px solid #78716c; }
        .g-8 { border-left: 4px solid #db2777; }
        .g-\? { border-left: 4px solid #000; background: #eee; }

        /* MODALS */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 200; }
        .modal { background: white; padding: 20px; border-radius: 8px; width: 400px; display: flex; flex-direction: column; gap: 15px; }
        textarea { height: 120px; padding: 8px; font-family: monospace; border: 1px solid #ccc; }
        
        #status-dot { height: 8px; width: 8px; border-radius: 50%; background: #ef4444; display: inline-block; margin-right: 5px; }

        /* READ ONLY OVERRIDES */
        body.readonly .controls { display: none !important; }
        body.readonly .chip { pointer-events: none; cursor: default; }
        body.readonly .slot { pointer-events: none; cursor: default; }
        body.readonly th { pointer-events: none; cursor: default; }
    </style>
</head>
<body>

<header>
    <h2>Scheduler <small style="font-size:0.7rem; font-weight:400; color:#666;"><span id="status-dot"></span><span id="status-msg">Offline</span></small></h2>
    
    <div class="tabs">
        <button class="tab active" onclick="setDay('Mon')">MON</button>
        <button class="tab" onclick="setDay('Tue')">TUE</button>
        <button class="tab" onclick="setDay('Wed')">WED</button>
        <button class="tab" onclick="setDay('Thu')">THU</button>
        <button class="tab" onclick="setDay('Fri')">FRI</button>
        <div class="tab-sep"></div>
        <button class="tab" onclick="setDay('Duty')">DUTY</button>
        <button class="tab" onclick="setDay('Recess')">RECESS</button>
    </div>

    <div class="controls">
        <button class="btn-share" onclick="shareReadOnly()">üîó Share</button>
        <button class="btn-doc" onclick="copyToClipboard()">Copy</button>
        <button class="btn-csv" onclick="exportCSV()">CSV</button>
        <button class="btn-imp" onclick="showModal()">Import</button>
        <button onclick="add('time')">+ Time</button>
        <button onclick="add('teacher')">+ Tea</button>
        <button class="btn-sec" onclick="resetDB()">‚ö†Ô∏è Reset</button>
    </div>
</header>

<div class="layout">
    <div class="sidebar">
        <div class="sidebar-content" id="sb-content"></div>
        <div style="padding:10px; border-top:1px solid #eee;">
            <button style="width:100%" onclick="add('class')">+ Class</button>
        </div>
    </div>
    <div class="grid-area">
        <table id="grid">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<div class="modal-mask" id="modal">
    <div class="modal">
        <h3>Bulk Import</h3>
        <p style="font-size:0.8rem; color:#666; margin:0;">
            <strong>For Classes:</strong> Paste list (e.g. <em>Smith 4</em>)
        </p>
        <select id="imp-type">
            <option value="c">Classes (Smart Detect)</option>
            <option value="t">Teachers (Columns)</option>
            <option value="tm">Times (Rows)</option>
        </select>
        <textarea id="imp-data" placeholder="Paste list here..."></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-sec" onclick="closeModal()">Cancel</button>
            <button class="btn-imp" onclick="runImport()">Import</button>
        </div>
    </div>
</div>
<div id="hidden-export" style="position:fixed; left:-9999px;"></div>

<script>
    // -----------------------------------------------------------
    // 1. FIREBASE CONFIG (Paste Here)
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBYEaVQnOZMBk8sCyoEVQXNuEoxZ54NFYo",
        authDomain: "schoolschedule-d83d1.firebaseapp.com",
        databaseURL: "https://schoolschedule-d83d1-default-rtdb.firebaseio.com",
        projectId: "schoolschedule-d83d1",
        storageBucket: "schoolschedule-d83d1.firebasestorage.app",
        messagingSenderId: "704127831300",
        appId: "1:704127831300:web:662bc8c704583a49605451",
        measurementId: "G-CZLW6LW52E"
    };

    if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    const DEFAULTS = {
        teachers: [{id:'t1',name:'Art'},{id:'t2',name:'Music'},{id:'t3',name:'PE'}],
        times: [{id:'tm1',label:'8:30 - 9:10'},{id:'tm2',label:'9:15 - 9:55'}],
        classes: [],
        // ADDED 'Duty' and 'Recess' to the assignments object
        assignments: { Mon:{}, Tue:{}, Wed:{}, Thu:{}, Fri:{}, Duty:{}, Recess:{} }
    };
    
    let data = JSON.parse(JSON.stringify(DEFAULTS));
    let day = 'Mon';
    let selection = null;

    const urlParams = new URLSearchParams(window.location.search);
    const isReadOnly = urlParams.get('mode') === 'view';
    if (isReadOnly) document.body.classList.add('readonly');

    // --- INIT ---
    function init() {
        const ref = db.ref('schoolSchedule');
        ref.on('value', snap => {
            const val = snap.val();
            if(val) {
                data = val;
                if(!data.assignments) data.assignments = DEFAULTS.assignments;
                
                // Ensure all tabs exist in data
                ['Mon','Tue','Wed','Thu','Fri','Duty','Recess'].forEach(d => { 
                    if(!data.assignments[d]) data.assignments[d]={}; 
                });
                
                if(!data.teachers) data.teachers = [];
                if(!data.times) data.times = [];
                if(!data.classes) data.classes = [];
                
                setStatus('Online', '#22c55e');
                render();
            } else {
                data = JSON.parse(JSON.stringify(DEFAULTS));
                save();
            }
        }, err => setStatus('Error/Offline', '#ef4444'));
    }

    function save() {
        if(isReadOnly) return;
        db.ref('schoolSchedule').set(data);
    }

    function setStatus(msg, color) {
        document.getElementById('status-msg').innerText = msg;
        document.getElementById('status-dot').style.background = color;
    }

    function setDay(d) {
        day = d;
        document.querySelectorAll('.tab').forEach(b => b.classList.toggle('active', b.innerText === d.toUpperCase()));
        selection = null;
        render();
    }

    function shareReadOnly() {
        const url = window.location.protocol + "//" + window.location.host + window.location.pathname + "?mode=view";
        navigator.clipboard.writeText(url).then(() => alert("‚úÖ Link Copied! Send to staff."));
    }

    // --- LOGIC ---
    function assign(slotKey, itemId) {
        if(!itemId) return;
        if (!itemId.startsWith('SYS_')) {
            const dayMap = data.assignments[day];
            for(const k in dayMap) {
                if(dayMap[k] === itemId) delete dayMap[k];
            }
        }
        data.assignments[day][slotKey] = itemId;
        selection = null;
        render(); save();
    }

    function unassign(slotKey) {
        delete data.assignments[day][slotKey];
        render(); save();
    }

    function moveCol(fromIdx, toIdx) {
        if(fromIdx===toIdx) return;
        const item = data.teachers.splice(fromIdx, 1)[0];
        data.teachers.splice(toIdx, 0, item);
        render(); save();
    }

    // --- RENDERERS ---
    function render() {
        const sb = document.getElementById('sb-content');
        sb.innerHTML = '';

        // 1. Planning Blocks
        createSidebarGroup(sb, 'Planning', ['LUNCH','PREP','MEET']);
        
        // 2. Duty Tags (NEW)
        createSidebarGroup(sb, 'Duty Tags', ['Cafeteria','Playground','Hallway','Bus','Gym'], true);

        // 3. Classes
        const grades = [...new Set(data.classes.map(c=>c.grade))].sort((a,b) => {
            if(a === 'K') return -1; if(b === 'K') return 1;
            if(a === '?') return 1; if(b === '?') return -1;
            return a - b;
        });

        grades.forEach(g => {
            const gDiv = document.createElement('div');
            gDiv.innerHTML = `
                <div class="group-header">
                    <span>Grade ${g}</span>
                    <span class="del-group-btn" onclick="delGrade('${g}')">delete all</span>
                </div>`;
            
            const grid = document.createElement('div');
            grid.className = 'chip-grid';
            data.classes.filter(c => c.grade === g).forEach(c => {
                const d = document.createElement('div');
                d.className = `chip g-${c.grade}`;
                if(selection === c.id) d.classList.add('selected');
                d.innerText = c.name;
                d.draggable = true;
                d.ondragstart = (e) => { e.dataTransfer.setData('id', c.id); };
                d.onclick = () => { selection = (selection===c.id)?null:c.id; render(); };
                d.ondblclick = () => { const n=prompt('Rename:',c.name); if(n){c.name=n;save();render();} };
                d.oncontextmenu = (e) => { e.preventDefault(); if(confirm(`Delete ${c.name}?`)) delClass(c.id); };
                grid.appendChild(d);
            });
            gDiv.appendChild(grid);
            sb.appendChild(gDiv);
        });

        renderGrid();
    }

    // Helper to create Sys/Duty blocks
    function createSidebarGroup(parent, title, items, isDuty=false) {
        const div = document.createElement('div');
        div.innerHTML = `<div class="group-header">${title}</div><div class="chip-grid"></div>`;
        const grid = div.querySelector('.chip-
